@echo off
setlocal EnableExtensions EnableDelayedExpansion
color 0A

rem =====================================================
rem     BUILD PriceBot.exe ‚Äî wersja z PyInstallerem
rem =====================================================

set "APP_NAME=PriceBot"
set "ENTRY_FILE=selektor_csv.py"
set "LOG_FILE=build.log"

echo =====================================================
echo     BUILD %APP_NAME%.exe
echo =====================================================
echo.

echo [1] Tworzƒô log: %LOG_FILE%
echo ==== BUILD START %DATE% %TIME% ==== > "%LOG_FILE%"

rem --- sprawdzenie zapisu ---
set "TMPFILE=__write_test__.tmp"
2>nul ( > "%TMPFILE%" echo test ) || (
  echo [ERR] Brak uprawnie≈Ñ do zapisu w %CD%
  echo [ERR] Uruchom CMD jako Administrator lub przenie≈õ projekt do np. C:\dev\
  exit /b 1
)
del "%TMPFILE%" >nul 2>&1

rem --- sprawd≈∫ ≈õcie≈ºkƒô ---
echo %CD% | findstr /I "OneDrive" >nul && (
  echo [WARN] Projekt jest w OneDrive ‚Äî to mo≈ºe blokowaƒá zapis.
  echo [WARN] Zalecane: przenie≈õ projekt np. do C:\PriceBot
)

rem --- znajd≈∫ Pythona ---
set "PYEXE="
where py >nul 2>&1 && set "PYEXE=py -3"
if "%PYEXE%"=="" where python >nul 2>&1 && set "PYEXE=python"
if "%PYEXE%"=="" (
  echo [ERR] Nie znaleziono Pythona w PATH.
  echo [ERR] Zainstaluj Python 3.10+ i dodaj do PATH.
  exit /b 1
)
echo [OK] Wykryto: %PYEXE%

rem --- sprawd≈∫ PyInstaller ---
%PYEXE% -m PyInstaller --version >nul 2>&1
if errorlevel 1 (
  echo [INFO] Instalujƒô PyInstaller...
  %PYEXE% -m pip install pyinstaller >nul
  if errorlevel 1 (
    echo [ERR] Nie uda≈Ço siƒô zainstalowaƒá PyInstaller.
    exit /b 1
  )
)
echo [OK] PyInstaller gotowy.

rem --- sprawd≈∫ inne zale≈ºno≈õci ---
for %%M in (pandas requests beautifulsoup4 numpy openpyxl) do (
  %PYEXE% -c "import %%M" >nul 2>&1
  if errorlevel 1 (
    echo [INFO] Brakuje %%M ‚Äî instalujƒô...
    %PYEXE% -m pip install %%M >nul
  )
)

rem --- wykryj Controlled Folder Access (PowerShell) ---
for /f "delims=" %%S in ('powershell -NoProfile -Command "(Get-MpPreference).EnableControlledFolderAccess" 2^>nul') do set "CFA=%%S"
if /I "%CFA%"=="1" (
  echo [WARN] Controlled Folder Access jest W≈ÅƒÑCZONY.
  echo [WARN] Mo≈ºe blokowaƒá zapis do folderu dist/. Dodaj Pythona do wyjƒÖtk√≥w w Defenderze.
)

rem --- usu≈Ñ poprzednie buildy ---
if exist build rmdir /s /q build
if exist dist rmdir /s /q dist
if exist "%APP_NAME%.spec" del "%APP_NAME%.spec" >nul

rem --- budowa EXE ---
echo [BUILD] Tworzƒô %APP_NAME%.exe ...
%PYEXE% -m PyInstaller "%ENTRY_FILE%" ^
    --onefile ^
    --noconsole ^
    --clean ^
    --name "%APP_NAME%" ^
    --log-level=WARN ^
    --add-data "app_paths.py;." ^
    --add-data "bazadanych.py;." ^
    --add-data "linki_mieszkania.py;." ^
    --add-data "scraper_otodom.py;." ^
    --add-data "scraper_otodom_mieszkania.py;." ^
    --add-data "CzyszczenieAdresu.py;." ^
    --add-data "automat.py;." ^
    --add-data "kolumny.py;." ^
    --add-data "scalanie.py;." ^
    --add-data "LOKAL_MIESZKALNY.py;." ^
    --add-data "jeden_w≈Ça≈õciciel.py;." ^
    --add-data "jeden_w≈Ça≈õciciel_i_LOKAL_MIESZKALNY.py;." ^
    --add-data "cofnij.py;." ^
    --add-data "pricebot_launcher.py;." ^
    --add-data "bootstrap_files.py;." ^
    >> "%LOG_FILE%" 2>&1

if errorlevel 1 (
  echo [ERR] Budowa NIE powiod≈Ça siƒô ‚Äî sprawd≈∫ build.log
  exit /b 1
)

if not exist "dist\%APP_NAME%.exe" (
  echo [ERR] Nie znaleziono pliku dist\%APP_NAME%.exe
  exit /b 1
)

echo.
echo [OK] UDA≈ÅO SIƒò üéâ
echo [OK] Utworzono: dist\%APP_NAME%.exe
echo [INFO] Uruchom: dist\%APP_NAME%.exe
echo.
pause
exit /b 0
